<app-navbar>

  <div *ngIf="isLoading" class="loading-container">
    <div class="spinner"></div>
    <p>Loading dashboard...</p>
  </div>

  <div *ngIf="!isLoading" class="dashboard-content">

    <div class="top-header">
      <div>
        <p class="greeting">Good {{ greeting() }}, {{ userName }} &#x1F44B;</p>
        <h1 class="page-title">Financial Overview</h1>
      </div>
      <div class="date-pill">{{ todayLabel }} &middot; Day {{ dayOfMonth }} of {{ totalDaysInMonth }}</div>
    </div>

    <div *ngIf="alertBudget" class="alert-banner">
      <span class="alert-icon">&#x26A0;&#xFE0F;</span>
      <span class="alert-text">
        <strong>{{ alertBudget.category?.name || 'A budget' }}</strong>
        is at {{ budgetPct(alertBudget) | number:'1.0-0' }}% &mdash;
        only &#x20AC;{{ fmt(budgetRemaining(alertBudget)) }} remaining for {{ daysRemaining }} days.
      </span>
      <span class="alert-action" (click)="goTo('budgets')">Adjust &rarr;</span>
    </div>

    <div class="hero-card"
         [class.hero-warning]="financialStatus === 'warning'"
         [class.hero-danger]="financialStatus === 'danger'">

      <div class="hero-left">
        <p class="hero-label">&#x2726; Safe to spend today</p>
        <div class="hero-amount">
          <span class="hero-currency">&#x20AC;</span>{{ fmt(safeToSpend) }}
        </div>
        <p class="hero-subtitle">
          Spent <strong>&#x20AC;{{ fmt(totalExpense) }}</strong> this month
          &middot; Balance <strong>&#x20AC;{{ fmt(balance) }}</strong>
          &middot; {{ daysRemaining }} days remaining<br>
          <span [class]="'pace-label pace-' + financialStatus">
            <ng-container *ngIf="financialStatus === 'good'">You're on track for this month.</ng-container>
            <ng-container *ngIf="financialStatus === 'warning'">Some budgets need attention.</ng-container>
            <ng-container *ngIf="financialStatus === 'danger'">Balance is negative &mdash; review your spending.</ng-container>
          </span>
        </p>
      </div>

      <div class="hero-right">
        <div class="status-badge" [class]="'status-' + financialStatus">
          <span class="status-dot"></span>{{ statusLabel }}
        </div>
        <div class="hero-meta">
          <span>Income: <strong>&#x20AC;{{ fmt(totalIncome) }}</strong></span>
          <span>Spent: <strong>&#x20AC;{{ fmt(totalExpense) }}</strong></span>
          <span>Balance: <strong>&#x20AC;{{ fmt(balance) }}</strong></span>
        </div>
      </div>

    </div>

    <div class="stats-row">

      <div class="stat-card">
        <div class="stat-icon icon-green">&#x1F4B0;</div>
        <div class="stat-info">
          <p class="stat-label">Income this month</p>
          <p class="stat-value value-green">&#x20AC;{{ fmt(totalIncome) }}</p>
          <p class="stat-delta"
             [class.delta-up]="incomeVsLastMonth >= 0"
             [class.delta-down]="incomeVsLastMonth < 0">
            {{ incomeVsLastMonth >= 0 ? '&#x2191;' : '&#x2193;' }} {{ fmtDelta(incomeVsLastMonth) }} vs last month
          </p>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon icon-red">&#x1F4B8;</div>
        <div class="stat-info">
          <p class="stat-label">Spent this month</p>
          <p class="stat-value value-red">&#x20AC;{{ fmt(totalExpense) }}</p>
          <p class="stat-delta"
             [class.delta-up]="expenseVsLastMonth <= 0"
             [class.delta-down]="expenseVsLastMonth > 0">
            {{ expenseVsLastMonth <= 0 ? '&#x2193;' : '&#x2191;' }} {{ fmtDelta(expenseVsLastMonth) }} vs last month
          </p>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon icon-blue">&#x1F4C5;</div>
        <div class="stat-info">
          <p class="stat-label">Monthly average</p>
          <p class="stat-value value-blue">&#x20AC;{{ fmt(monthlyAvgExpense) }}</p>
          <p class="stat-delta" [class.delta-up]="monthlyAvgExpense <= totalExpense" [class.delta-down]="monthlyAvgExpense > totalExpense">
            <ng-container *ngIf="avgMonthsLoaded > 0">
              {{ totalExpense <= monthlyAvgExpense ? '&#x2193; Below' : '&#x2191; Above' }} avg &middot; &#x20AC;{{ fmt(monthlyAvgIncome) }} income avg
            </ng-container>
            <ng-container *ngIf="avgMonthsLoaded === 0">Not enough history yet</ng-container>
          </p>
        </div>
      </div>

    </div>

    <div class="bottom-grid">

      <div class="left-col">

        <div class="card">
          <div class="card-title">
            Budget Snapshot
            <span class="card-link" (click)="goTo('budgets')">Manage &rarr;</span>
          </div>

          <div *ngIf="budgetsSortedByRisk.length === 0" class="empty-state">
            <p>No budgets set for this month.</p>
            <button class="btn-link" (click)="goTo('budgets')">Create a budget &rarr;</button>
          </div>

          <div class="budget-list" *ngIf="budgetsSortedByRisk.length > 0">
            <ng-container *ngFor="let budget of budgetsSortedByRisk; let i = index">
              <div *ngIf="i > 0 && riskGroupChanged(i)" class="budget-divider"></div>
              <div class="budget-item">
                <div class="budget-top">
                  <span class="budget-name">
                    <span class="budget-emoji">{{ budget.category?.icon || '&#x1F4C1;' }}</span>
                    {{ budget.category?.name || 'Other' }}
                  </span>
                  <span class="budget-numbers">
                    <strong>&#x20AC;{{ fmt(budget.spent || 0) }}</strong> / &#x20AC;{{ fmt(budget.amount) }}
                  </span>
                </div>
                <div class="bar-track">
                  <div class="bar-fill"
                       [class]="'bar-' + budgetStatus(budget)"
                       [style.width.%]="budgetPct(budget)">
                  </div>
                </div>
                <p *ngIf="budgetStatus(budget) === 'danger'" class="budget-alert">
                  &#x26A0; &#x20AC;{{ fmt(budgetRemaining(budget)) }} left &middot; {{ daysRemaining }} days to go
                </p>
              </div>
            </ng-container>
          </div>
        </div>

        <div class="card">
          <div class="card-title">
            Spending this week
            <span class="card-link" (click)="goTo('reports')">Full report &rarr;</span>
          </div>
          <div class="chart-container">
            <canvas id="weekChart"></canvas>
          </div>
        </div>

      </div>

      <div class="card right-col">
        <div class="card-title">
          Recent
          <span class="card-link" (click)="goTo('transactions')">All &rarr;</span>
        </div>

        <div class="tx-today-total">
          <span>Today</span>
          <strong *ngIf="spentToday > 0">&ndash;&#x20AC;{{ fmt(spentToday) }}</strong>
          <span *ngIf="spentToday === 0" class="no-spend-today">No spending today &#x1F389;</span>
        </div>

        <div *ngIf="recentTransactions.length === 0" class="empty-state">
          <p>No transactions this month.</p>
          <button class="btn-link" (click)="goTo('transactions')">Add one &rarr;</button>
        </div>

        <div class="tx-list" *ngIf="recentTransactions.length > 0">
          <div class="tx-item"
               *ngFor="let tx of recentTransactions"
               (click)="goTo('transactions')">
            <div class="tx-icon">{{ tx.category?.icon || '&#x1F4B3;' }}</div>
            <div class="tx-details">
              <p class="tx-name">{{ tx.description || tx.category?.name }}</p>
              <p class="tx-cat">{{ tx.category?.name }}</p>
            </div>
            <div class="tx-right">
              <p class="tx-amount" [class.income]="tx.type === 'income'">
                {{ tx.type === 'income' ? '+' : '&ndash;' }}&#x20AC;{{ fmt(tx.amount) }}
              </p>
              <p class="tx-date">{{ fmtTxDate(tx.date) }}</p>
            </div>
          </div>
        </div>

        <button class="add-btn" (click)="goTo('transactions', {openModal: true})">+ Add Transaction</button>

      </div>

    </div>

  </div>

</app-navbar>